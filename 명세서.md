# 0. 목적

- collab_start_week 기준
- **2~6개월 전 구간의 트윗 수를 주차 단위로 집계**
- 이를 **count_lag_9w ~ count_lag_26w** 피처로 생성
- IP별 JSON 저장
- 엑셀 중간저장 및 재시작 가능 구조

---

# 1. 입력 데이터

## 파일

`data/Unique_Celebrity_Keyword.X.xlsx`

## 필수 컬럼

| 컬럼명            | 설명                           |
| ----------------- | ------------------------------ |
| variants_joined   | OR로 연결된 검색 키워드 문자열 |
| group.nd.name     | JSON 파일명 및 IP 식별자       |
| collab_start_week | ISO Year-Week 형식             |

---

# 2. 처리 흐름

---

## STEP 1. 엑셀 로드

1. `Celebrity_count.xlsx` 존재 시 우선 로드
2. 없으면 원본 로드 후 status 컬럼 생성

status 값:

- OK
- ERROR
- PENDING

---

## STEP 2. ISO Week → 실제 날짜 변환

- collab_start_week → ISO week 월요일 날짜로 변환
- Python: date.fromisocalendar(year, week, 1)

생성 컬럼:

- collab_start_date

---

## STEP 3. 수집 구간 정의

기준:

- 시작일 = collab_start_date - 6개월
- 종료일 = collab_start_date - 2개월

즉,

> 정확히 “2~6개월 전 구간”

ISO 8601 변환:

- YYYY-MM-DDTHH:MM:SSZ (UTC 기준)

---

# 3. API 요청 설계

## 엔드포인트

GET /2/tweets/counts/all

## Query 구성

(variants_joined) lang:ko -is:retweet -is:nullcast

## 파라미터

- start_time
- end_time
- granularity=day

---

# 4. lag 정의

## 기준 정의

lag_k = “콜라보 시작 주차 기준 k주 전”

예:

- lag_1w = collab_start_week - 1week
- lag_9w = collab_start_week - 9week
- lag_26w = collab_start_week - 26week

---

## 우리는 다음 범위만 사용

count_lag_9w ~ count_lag_26w

이 범위가 정확히:

> 콜라보 2개월 전 ~ 6개월 전 구간

설명:

- 1~8주는 직전 2개월 → 제외
- 9~26주 → 2~6개월 전 구간

---

## 생성 컬럼

총 18개 컬럼 생성:

count_lag_9w  
count_lag_10w  
...  
count_lag_26w

---

## 값 매핑 방식

1. weekly_counts 결과를 ISO week 기준으로 저장
2. collab_start_week에서 k주 빼서 target_week 계산
3. weekly_counts에서 해당 week의 count를 매핑
4. 없으면 NA

주의:

- NA ≠ 0
- NA는 “수집 범위 밖 또는 매칭 실패”

---

# 5. JSON 저장 구조

경로:  
data/json/{group.nd.name}.json

구조:

{  
"meta": {  
"ip_name": "",  
"query": "",  
"collab_start_week": "",  
"collab_start_date": "",  
"window_start": "",  
"window_end": ""  
},  
"weekly_counts": [
{
"week": "2025-W01",
"start": "",
"end": "",
"count": 123
}
],  
"lags": {  
"lag_9w": 345,  
...  
"lag_26w": 120  
},  
"total_count_2to6m": 000  
}

---

# 6. Rate Limit 정책

기본:

- sleep = 1.1초

헤더 기반 제어:

- x-rate-limit-remaining <= 10 이면
  - 다음꺼 까지만 조사하고 종료

---

# 7. 저장 전략 (IP 단위 원자성)

IP 하나 처리 완료 시:

1. JSON 저장
2. DF row 업데이트

   - status = OK

3. 엑셀 즉시 저장

---

# 8. 재시작 로직

프로그램 시작 시:

1. Celebrity_count.xlsx 존재 여부 확인
2. 존재하면 그 파일 로드
3. status == OK 행은 skip
4. 나머지만 처리

---

# 9. 오류 처리

IP 단위 try/except

오류 시:

- status = ERROR
- error_message 기록
- 엑셀 즉시 저장
- 다음 IP로 진행

---

# 10. 최종 출력

파일:  
`data/Celebrity_count.xlsx`

포함 컬럼:

- 원본 컬럼
- collab_start_date
- window_start
- window_end
- count_lag_9w ~ count_lag_26w
- total_count_lag
- status
- error_message
